 <!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Tra√ßabilit√© mati√®res ‚Äì Neige Azur</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
<link rel="manifest" href="manifest.json">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Neige Azur">

<style>
body { font-family: Arial, sans-serif; padding: 15px; }
h1 { color: #003366; }

input, select {
  width: 100%;
  padding: 8px;
  margin: 6px 0;
}

button:not(.tab-button) {
  width: 100%;
  padding: 8px;
  margin: 6px 0;
}

button { cursor: pointer; }

.tabs {
  display: flex;
  gap: 10px;
  margin: 15px 0 20px;
}

.tabs button {
  flex: 1;
  border: none;
  padding: 14px 8px;
  font-weight: 700;
  font-size: 14px;
  border-radius: 14px;
  color: #fff;
  cursor: pointer;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  transition: transform 0.1s ease;
}

.tabs button:active {
  transform: scale(0.96);
}

/* COULEURS FIXES */
#btn-mp {
  background: #2563eb; /* bleu */
}

#btn-ms {
  background: #16a34a; /* vert */
}

#btn-historique {
  background: #f59e0b; /* orange */
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}

th, td {
  border: 1px solid #ccc;
  padding: 6px;
  text-align: center;
}

.ok { background: #d4edda; }
.soon { background: #fff3cd; }
.expired { background: #f8d7da; }
.logo {
  display: block;
  margin: 20px auto 10px;
  max-width: 100px;
  height: auto;
}
 .home-title {
  text-align: center;
  margin: 20px 0 30px;
}

.home-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
  padding: 10px;
}

.home-card {
  border-radius: 18px;
  padding: 25px 10px;
  text-align: center;
  box-shadow: 0 6px 14px rgba(0,0,0,0.08);
  color: #fff;
}


.home-card:active {
  transform: scale(0.97);
  box-shadow: 0 4px 10px rgba(0,0,0,0.12);
}

.home-card .icon {
  font-size: 36px;
  margin-bottom: 10px;
}

.home-card .label {
  font-weight: bold;
  font-size: 15px;
}

.tabs button.active {
  background-clip: padding-box;
}
 /* RESET SAFARI */
.tab-button {
  flex: 1;
  border: none;
  padding: 12px 8px;
  font-weight: 600;
  font-size: 14px;
  border-radius: 12px;
  background: #e5e7eb !important;
  color: #374151 !important;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}

/* ACTIFS ‚Äì FORC√âS */
#btn-mp.active {
  background: #2563eb !important;
  color: #ffffff !important;
}

#btn-ms.active {
  background: #16a34a !important;
  color: #ffffff !important;
}

#btn-historique.active {
  background: #f59e0b !important;
  color: #ffffff !important;
}
 /* COULEURS ACCUEIL */
.home-card.ajout {
  background: #2563eb;
  color: #fff;
}

.home-card.stock {
  background: #16a34a;
  color: #fff;
}

.home-card.historique {
  background: #f59e0b;
  color: #fff;
}

.home-card.stats {
  background: #7c3aed;
  color: #fff;
}
.stats-box {
  background: #f3f4f6;
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 20px;
}

.stats-box p {
  margin: 6px 0;
}

#stats-matieres li {
  margin: 4px 0;
}
/* Seuil d‚Äôalerte */
input#seuil {
  border: 2px dashed #f59e0b;
}

/* Ligne stock bas */
.stock-bas {
  background-color: #fde68a !important;
}

/* Ligne critique */
.stock-critique {
  background-color: #fca5a5 !important;
}

 /* FEEDBACK TACTILE MOBILE */
button:active,
.home-card:active {
  transform: scale(0.96);
  opacity: 0.85;
}

 @media (max-width: 768px) {

  .home-grid {
    grid-template-columns: 1fr;
  }

  .home-card {
    min-height: 140px;
  }

}

</style>
</head>

<body>

<img src="logo-neige-azur.png" alt="Neige Azur" class="logo">

 <div id="home">

  <h1 class="home-title">Gestion des stocks</h1>

 <div class="home-grid">

  <div class="home-card ajout" data-section="ajout">
    <div class="icon">‚ûï</div>
    <div class="label">Ajout stock</div>
  </div>

  <div class="home-card stock" data-section="stock">
    <div class="icon">üì¶</div>
    <div class="label">Stock</div>
  </div>

  <div class="home-card historique" data-section="historique">
    <div class="icon">üßæ</div>
    <div class="label">Historique sorties</div>
  </div>

  <div class="home-card stats" data-section="stats">
    <div class="icon">üìä</div>
    <div class="label">Stats</div>
  </div>

</div>
  
</div> 


<div id="app" style="display:none;">

<button onclick="retourAccueil()">üè† Accueil</button>

<h1>Tra√ßabilit√© mati√®res ‚Äì Neige Azur</h1>

<div id="tab-ajout" style="display:none;">
<div id="feedback-ajout" style="display:none;color:green;font-weight:bold;">
  ‚úÖ Mati√®re ajout√©e au stock
</div>

  <h3>Ajouter un lot</h3>
 
<select id="categorie">
  <option value="">‚Äî Type de mati√®re ‚Äî</option>
  <option value="mp">Mati√®re premi√®re</option>
  <option value="ms">Mati√®re secondaire</option>
</select>

<div id="bloc-mp" style="display:none;">

  <!-- Fournisseur MP -->
  <select id="fournisseurMP">
    <option value="">‚Äî Choisir un fournisseur ‚Äî</option>
    <option value="Montaigu">Montaigu</option>
    <option value="Socovo">Socovo</option>
    <option value="Giraudon">Giraudon</option>
    <option value="Caragum">Caragum</option>
    <option value="Aigremont">Aigremont</option>
    <option value="Rogelfruits">Rogelfruits</option>
  </select>

  <!-- PRODUITS PAR FOURNISSEUR -->
  <div id="produits-Montaigu" style="display:none;">
    <select id="matiere-Montaigu">
      <option value="Lait entier">Lait entier</option>
      <option value="Lait 0%">Lait 0%</option>
      <option value="Cr√®me 35%">Cr√®me 35%</option>
        </select>
  </div>

   <div id="produits-Socovo" style="display:none;">
    <select id="matiere-Socovo">
      <option value="Jaune d'oeuf">Jaune d'oeuf</option>
      <option value="Blanc d'oeuf">Blanc d'oeuf</option>
      <option value="Oeuf entier">Oeuf entier </option>
    </select>
  </div> 
 
 <div id="produits-Giraudon" style="display:none;">
    <select id="matiere-Giraudon">
      <option value="Sucre">Sucre</option>
      <option value="Sucre inverti">Sucre inverti</option>
      <option value="Dextrose">Dextrose</option>
      <option value="Glucose">Glucose</option>
    </select>
  </div>

  <div id="produits-Caragum" style="display:none;">
    <select id="matiere-Caragum">
      <option value="Stabilisateur glace">Stabilisateur glace</option>
      <option value="Stabilisateur sorbet">Stabilisateur sorbet</option>
    </select>
  </div>
 
 <div id="produits-Aigremont" style="display:none;">
    <select id="matiere-Aigremont">
      <option value="Huile de coco">Huile de coco</option>
    </select>
  </div>
 
 <div id="produits-Rogelfruits" style="display:none;">
    <select id="matiere-Rogelfruits">
     <option value="Pur√©e de Ananas">Pur√©e de Ananas</option>
     <option value="Pur√©e de Banane">Pur√©e de Banane</option>
     <option value="Pur√©e de Cassis">Pur√©e de Cassis</option>
     <option value="Pur√©e de Citron">Pur√©e de Citron</option>
     <option value="Pur√©e de Citron Vert">Pur√©e de Citron Vert</option>
     <option value="Pur√©e de Fraise">Pur√©e de Fraise</option>
     <option value="Pur√©e de Framboise">Pur√©e de Framboise</option>
     <option value="Pur√©e de Mandarine">Pur√©e de Mandarine</option>
     <option value="Pur√©e de Mangue">Pur√©e de Mangue</option>
     <option value="Pur√©e de Melon">Pur√©e de Melon</option>
     <option value="Pur√©e de Passion">Pur√©e de Passion</option>
     <option value="Pur√©e de Peche de Vigne">Pur√©e de Peche de Vigne</option>
     <option value="Pur√©e de Poire">Pur√©e de Poire</option>
     <option value="Pur√©e de Pomme">Pur√©e de Pomme</option>
    </select>
  </div>

  <!-- CHAMPS COMMUNS MP -->
  <div id="champs-mp" style="display:none;">
    <input id="lot" placeholder="Num√©ro de lot">
    <select id="type">
      <option value="DLUO">DLUO</option>
      <option value="DLC">DLC</option>
    </select>
    <input id="dlc" type="date">
    <input id="quantite" type="number" placeholder="Quantit√© (sacs)">
    <input id="seuil" type="number" placeholder="Seuil d‚Äôalerte" style="display:none">
  </div>

</div>

 <div id="bloc-ms" style="display:none;">

  <!-- Fournisseur -->
  <select id="fournisseurMS">
    <option value="">‚Äî Choisir un fournisseur ‚Äî</option>
    <option value="transgourmet">Transgourmet</option>
    <option value="metro">Metro</option>
    <option value="promocash">Promocash</option>
  </select>

  <!-- PRODUITS TRANSGOURMET -->
  <div id="produits-transgourmet" style="display:none;">
    <select id="matiereMS-transgourmet">
      <option value="Bac plastique">Bac plastique</option>
      <option value="Couvercle">Couvercle</option>
      <option value="Film alimentaire">Film alimentaire</option>
    </select>
  </div>

  <!-- PRODUITS METRO -->
  <div id="produits-metro" style="display:none;">
    <select id="matiereMS-metro">
      <option value="Carton">Carton</option>
      <option value="Barquette">Barquette</option>
      <option value="Sachet">Sachet</option>
    </select>
  </div>

  <!-- PRODUITS PROMOCASH -->
  <div id="produits-promocash" style="display:none;">
    <select id="matiereMS-promocash">
      <option value="√âtiquette">√âtiquette</option>
      <option value="Film √©tirable">Film √©tirable</option>
    </select>
  </div>

 <!-- CHAMPS COMMUNS MATI√àRES SECONDAIRES -->
<div id="champs-ms" style="display:none;">

  <select id="typeMS">
    <option value="DLUO">DLUO</option>
    <option value="DLC">DLC</option>
  </select>

  <input id="dateMS" type="date">
  <input id="quantiteMS" type="number" placeholder="Quantit√©">
  <input id="seuilMS" type="number" placeholder="Seuil d‚Äôalerte">

</div>

</div>


  <button onclick="ajouterLot().catch(console.error)">Ajouter</button>
</div>

 <div id="tab-stock" style="display:none;">

  <h3>Stock actuel</h3>

  <table>
    <thead>
      <tr>
        <th>Mati√®re</th>
        <th>Fournisseur</th>
        <th>Lot</th>
        <th>DLC / DLUO</th>
        <th>Quantit√©</th>
        <th>Sortie</th>
      </tr>
    </thead>
    <tbody id="tableStock"></tbody>
  </table>

  <h3>Sorties du mois en cours</h3>
  <ul id="sortiesMoisListe"></ul>

</div>

<div id="tab-historique" style="display:none;">

<h3>Historique des sorties</h3>

<select id="moisSelect">
  <option value="">‚Äî Choisir un mois ‚Äî</option>
</select>

<table>
<thead>
<tr>
<th>Date</th>
<th>Mati√®re</th>
<th>Lot</th>
<th>Quantit√©</th>
</tr>
</thead>
<tbody id="tableHistorique"></tbody>
</table>

</div>

<div id="tab-stats" style="display:none;">

  <h3>üìä Statistiques</h3>

  <div class="stats-box">
    <p><strong>Total sorties ce mois :</strong> <span id="stat-total-sorties">0</span> sacs</p>
    <p><strong>Nombre de mouvements :</strong> <span id="stat-nb-sorties">0</span></p>
  </div>

  <h4>Mati√®res les plus utilis√©es</h4>
  <ul id="stats-matieres"></ul>

 <h4>üì¶ Fournisseurs</h4>
<ul id="stats-fournisseurs"></ul>

</div>
</div>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import {
    getFirestore,
    doc,
    getDoc,
    setDoc,
    onSnapshot
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "TON_API_KEY",
    authDomain: "neigeazur-stock.firebaseapp.com",
    projectId: "neigeazur-stock",
    storageBucket: "neigeazur-stock.appspot.com",
    messagingSenderId: "XXXXXXXX",
    appId: "XXXXXXXX"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.db = db;
  window.doc = doc;
  window.getDoc = getDoc;
  window.setDoc = setDoc;
  window.onSnapshot = onSnapshot;
</script>

<script>

let stock = [];
let sortiesMois = [];
let historiqueMois = [];
let moisActuel = new Date().getMonth();
// üîî Seuils d'alerte par mati√®re (en sacs)
const seuils = {
  "Sucre": 25,
  "Sucre inverti": 5,
  "Dextrose": 15,
  "Glucose": 15,
  "Lait entier": 15,
  "Lait 0%": 15,
  "Cr√®me 35%": 10,
  "Jaune d'≈ìuf": 30,
  "Huile de coco": 50,
  "Stabilisateur glace": 2,
  "Stabilisateur sorbet": 2,
  "Pur√©e de Ananas": 3,
  "Pur√©e de Banane": 5,
  "Pur√©e de Cassis": 5,
  "Pur√©e de Citron": 10,
  "Pur√©e de Citron Vert": 5,
  "Pur√©e de Fraise": 15,
  "Pur√©e de Framboise": 10,
  "Pur√©e de Mandarine": 10,
  "Pur√©e de Mangue": 10, 
  "Pur√©e de Melon": 10,
  "Pur√©e de Passion": 10,
  "Pur√©e de Peche de Vigne": 5,
  "Pur√©e de Poire": 3,
  "Pur√©e de Pomme": 3,
};

// üîî Seuils automatiques par mati√®re
const seuilsParMatiere = {
  "Lait entier": 4,
  "Lait 0%": 4,
  "Cr√®me 35%": 3,

  "Jaune d'oeuf": 2,
  "Blanc d'oeuf": 2,
  "Oeuf entier": 2,

  "Sucre": 5,
  "Sucre inverti": 3,
  "Dextrose": 3,
  "Glucose": 3,

  "Stabilisateur glace": 1,
  "Stabilisateur sorbet": 1,

  "Huile de coco": 2,
  "Pur√©e de Ananas": 3,
  "Pur√©e de Banane": 5,
  "Pur√©e de Cassis": 5,
  "Pur√©e de Citron": 10,
  "Pur√©e de Citron Vert": 5,
  "Pur√©e de Fraise": 15,
  "Pur√©e de Framboise": 10,
  "Pur√©e de Mandarine": 10,
  "Pur√©e de Mangue": 10, 
  "Pur√©e de Melon": 10,
  "Pur√©e de Passion": 10,
  "Pur√©e de Peche de Vigne": 5,
  "Pur√©e de Poire": 3,
  "Pur√©e de Pomme": 3,
};



// üîß R√©f√©rences DOM (OBLIGATOIRE avec type="module")
const matiere = document.getElementById("matiere");
const matiereAutre = document.getElementById("matiereAutre");
const fournisseur = document.getElementById("fournisseur");
const fournisseurAutre = document.getElementById("fournisseurAutre");
const lot = document.getElementById("lot");
const type = document.getElementById("type");
const dlc = document.getElementById("dlc");
const quantite = document.getElementById("quantite");

const tableStock = document.getElementById("tableStock");
const sortiesMoisListe = document.getElementById("sortiesMoisListe");
const seuil = document.getElementById("seuil");
function estExpire(lot){
  if(!lot.date) return false;

  const aujourdHui = new Date();
  const dateLot = new Date(lot.date);

  // DLC stricte
  if(lot.type === "DLC"){
    return dateLot < aujourdHui;
  }

  // DLUO avec tol√©rance de 30 jours
  if(lot.type === "DLUO"){
    const tol = new Date(dateLot);
    tol.setDate(tol.getDate() + 30);
    return tol < aujourdHui;
  }

  return false;
}

async function save() {
  const ref = doc(window.db, "neigeazur", "data");

  await setDoc(
    ref,
    {
      stock: stock,
      sortiesMois: sortiesMois,
      historiqueMois: historiqueMois,
      moisActuel: moisActuel,
      updatedAt: new Date()
    },
    { merge: true }
  );
}

function showTab(tab) {
  ["ajout", "stock", "historique", "stats"].forEach(t => {
    const el = document.getElementById("tab-" + t);
    if (el) el.style.display = "none";
  });

  const actif = document.getElementById("tab-" + tab);
  if (actif) actif.style.display = "block";

  if (tab === "stats") calculerStats();
}



async function ajouterLot(){

if (categorie.value === "mp") {

  const fournisseur = fournisseurMP.value;
  if (!fournisseur) {
    alert("Choisir un fournisseur");
    return;
  }

  const selectProduit = document.querySelector(
    `#produits-${fournisseur} select`
  );

  if (!selectProduit) return;

  const matiere = selectProduit.value;
  if (!matiere || !quantite.value) {
    alert("Champs incomplets");
    return;
  }
const seuilAuto = seuilsParMatiere[matiere];
if (seuilAuto === undefined) {
  console.warn("‚ö†Ô∏è Aucun seuil d√©fini pour", matiere);
}

  stock.unshift({
    categorie: "MP",
    matiere: matiere,
    fournisseur: fournisseur,
    lot: lot.value || "SANS LOT",
    type: type.value,
    date: dlc.value,
    sacs: Number(quantite.value),
    seuil: seuilsParMatiere[matiere] ?? 0
  });
}

if (categorie.value === "ms") {

  const fournisseur = fournisseurMS.value;
  let matiere = "";

  if (fournisseur === "transgourmet") {
    matiere = document.getElementById("matiereMS-transgourmet").value;
  }

  if (fournisseur === "metro") {
    matiere = document.getElementById("matiereMS-metro").value;
  }

  if (fournisseur === "promocash") {
    matiere = document.getElementById("matiereMS-promocash").value;
  }
  
const type = document.getElementById("typeMS").value;
const date = document.getElementById("dateMS").value;
const qte = document.getElementById("quantiteMS").value;
const seuil = document.getElementById("seuilMS").value;


  if (!fournisseur || !matiere || !qte) return;

  stock.unshift({
    categorie: "MS",
    matiere: matiere,
    fournisseur: fournisseur,
    lot: "",
    type: type,
date: date,
sacs: Number(qte),
seuil: Number(seuil) || 0

  });
}

 await save();
afficher();
// ‚úÖ feedback visuel
const feedback = document.getElementById("feedback-ajout");
if (feedback) {
  feedback.style.display = "block";
  setTimeout(() => {
    feedback.style.display = "none";
  }, 2000);
}

// ‚úÖ reset du formulaire
resetAjoutStock();

// ‚úÖ retour √† l‚Äôaccueil
retourAccueil();
}


// üîß Exposition des fonctions pour les onclick HTML
window.ajouterLot = ajouterLot;
window.validerSortie = validerSortie;
window.showTab = showTab;
 
function afficher() {

  if (!tableStock) return;

  tableStock.innerHTML = "";

  // üî¢ Calcul du total par mati√®re
  const totalParMatiere = {};
  stock.forEach(lot => {
    totalParMatiere[lot.matiere] =
      (totalParMatiere[lot.matiere] || 0) + lot.sacs;
  });

  // üì¶ Affichage du stock
  stock.forEach((x, i) => {
    let classe = "";

    const total = totalParMatiere[x.matiere];
    const seuil = x.seuil;

    if (estExpire(x)) {
      classe = "expired";
    } 
    else if (seuil !== undefined && total <= seuil) {
      classe = "stock-critique";
    }

    tableStock.innerHTML += `
      <tr class="${classe}">
        <td>${x.matiere}</td>
        <td>${x.fournisseur}</td>
        <td>${x.lot}</td>
        <td>${x.date || ""}</td>
        <td>${x.sacs}</td>
        <td>
          <input type="number" id="sortie-${i}" style="width:50px">
          <button onclick="validerSortie(${i})">‚úîÔ∏è</button>
          <button onclick="editerStock(${i})" title="Modifier">‚úèÔ∏è</button>
          <button onclick="supprimerStock(${i})" title="Supprimer">üóëÔ∏è</button>
        </td>
      </tr>
    `;
  });

  afficherSortiesMois();
}


function afficherSortiesMois() {
  if (!sortiesMoisListe) return;

  sortiesMoisListe.innerHTML = "";

  [...sortiesMois]
    .map((s, i) => ({ ...s, _index: i }))
    .sort((a, b) => {
      const da = new Date(a.date.split("/").reverse().join("-"));
      const db = new Date(b.date.split("/").reverse().join("-"));
      return db - da;
    })
    .forEach(s => {
      sortiesMoisListe.innerHTML += `
        <li id="sortie-${s._index}">
          <span>
            ${s.date} ‚Äì 
            ${s.quantite} sacs ‚Äì 
            ${s.matiere} |
            Lot : ${s.lot || "‚Äî"} |
            ${s.type || ""} : ${s.dlc || "‚Äî"}
          </span>
          <button onclick="editerSortie(${s._index})">‚úèÔ∏è</button>
          <button onclick="supprimerSortie(${s.id})">üóëÔ∏è</button>

        </li>
      `;
    });
}



async function validerSortie(i) {
  const q = Number(document.getElementById("sortie-" + i).value);
  if (!q || q > stock[i].sacs) return;

  const id = Date.now(); // ‚úÖ ID UNIQUE PARTAG√â

  stock[i].sacs -= q;

  const sortie = {
    id: id,
    date: new Date().toLocaleDateString("fr-FR"),
    matiere: stock[i].matiere,
    lot: stock[i].lot || "SANS LOT",
    dlc: stock[i].date,
    type: stock[i].type,
    quantite: q
  };

  sortiesMois.push(sortie);
  historiqueMois.push({ ...sortie }); // ‚úÖ M√äME ID

  await save();
  afficher();
}




function calculerStats(){

  const totalEl = document.getElementById("stat-total-sorties");
  const nbEl = document.getElementById("stat-nb-sorties");
  const ul = document.getElementById("stats-matieres");

  if (!totalEl || !nbEl || !ul) return;

  let total = 0;
  let compteur = {};

  sortiesMois.forEach(s => {
    total += s.quantite;
    compteur[s.matiere] = (compteur[s.matiere] || 0) + s.quantite;
  });

  totalEl.textContent = total;
  nbEl.textContent = sortiesMois.length;

  ul.innerHTML = "";

  Object.entries(compteur)
    .sort((a,b) => b[1] - a[1])
    .forEach(([matiere, qte]) => {
      ul.innerHTML += `<li>${matiere} : ${qte} sacs</li>`;
    });
}
const ulF = document.getElementById("stats-fournisseurs");
if(ulF){
  ulF.innerHTML = "";

  const fournisseurs = statsFournisseurs();

  Object.entries(fournisseurs).forEach(([nom, data])=>{
    ulF.innerHTML += `
      <li>
        <strong>${nom}</strong> :
        ${data.lots} lots,
        ${data.sacs} sacs,
        ${data.expires} p√©rim√©s
      </li>
    `;
  });
}


async function chargerDonneesFirebase() {
  const ref = doc(window.db, "neigeazur", "data");
  const snap = await getDoc(ref);

  if (snap.exists()) {
    const data = snap.data();
    stock = data.stock || [];
    sortiesMois = data.sortiesMois || [];
    historiqueMois = data.historiqueMois || [];
    moisActuel = data.moisActuel ?? new Date().getMonth();
  }

  // üî• NETTOYAGE DEFINITIF
  nettoyerHistoriqueOrphelin();

  await save(); // ‚¨ÖÔ∏è √âCRIT LE NETTOYAGE EN BASE

  afficher();
  afficherSortiesMois();
}


function ecouterFirebase() {
  const ref = doc(window.db, "neigeazur", "data");

  onSnapshot(ref, (snap) => {
    if (snap.exists()) {
      const data = snap.data();
      stock = data.stock || [];
      sortiesMois = data.sortiesMois || [];
      historiqueMois = data.historiqueMois || [];
      moisActuel = data.moisActuel ?? new Date().getMonth();

      afficher();
      afficherSortiesMois();
    }
  });
}

function openSection(section) {
  console.log("OPEN SECTION:", section);

  const home = document.getElementById("home");
  const app = document.getElementById("app");

  if (!home || !app) {
    console.error("home ou app introuvable");
    return;
  }

  home.style.display = "none";
  app.style.display = "block";

  // cacher tous les onglets
  ["ajout", "stock", "historique", "stats"].forEach(t => {
    const el = document.getElementById("tab-" + t);
    if (el) el.style.display = "none";
  });

  // üî• RESET OBLIGATOIRE quand on ouvre Ajout stock
  if (section === "ajout") {
    resetAjoutStock();   // ‚¨ÖÔ∏è LA LIGNE QUI MANQUAIT
  }

  const target = document.getElementById("tab-" + section);
  if (!target) {
    console.error("Onglet introuvable :", section);
    return;
  }

  target.style.display = "block";

  if (section === "historique") {
    afficherHistorique();
  }

  if (section === "stats") {
    calculerStats();
  }
 if (section === "stock") {
  afficher();
}
}

window.openSection = openSection;


function retourAccueil() {
  document.getElementById("app").style.display = "none";
  document.getElementById("home").style.display = "block";
}
function stockParMatiere() {
  const total = {};

  stock.forEach(lot => {
    total[lot.matiere] = (total[lot.matiere] || 0) + lot.sacs;
  });

  return total;
}
function verifierAlertes() {
  const total = stockParMatiere();

  Object.entries(seuils).forEach(([matiere, seuil]) => {
    if ((total[matiere] || 0) <= seuil) {
      console.warn(`‚ö†Ô∏è Stock bas : ${matiere}`);
    }
  });
}
function statsFournisseurs(){
  const stats = {};

  stock.forEach(lot=>{
    if(!stats[lot.fournisseur]){
      stats[lot.fournisseur] = {
        lots: 0,
        expires: 0,
        sacs: 0
      };
    }

    stats[lot.fournisseur].lots++;
    stats[lot.fournisseur].sacs += lot.sacs;

    if(estExpire(lot)){
      stats[lot.fournisseur].expires++;
    }
  });

  return stats;
}

window.addEventListener("load", () => {
  chargerDonneesFirebase();
  ecouterFirebase();
});
const categorie = document.getElementById("categorie");
const blocMP = document.getElementById("bloc-mp");
const blocMS = document.getElementById("bloc-ms");

categorie.addEventListener("change", () => {
  // cacher tout
  blocMP.style.display = "none";
  blocMS.style.display = "none";

  // üî• cacher produits MP
  Object.values(blocsProduitsMP).forEach(b => b.style.display = "none");
  champsMP.style.display = "none";

  // üî• cacher produits MS
  Object.values(blocsProduitsMS).forEach(b => b.style.display = "none");
  champsMS.style.display = "none";

  // afficher uniquement le bon bloc
  if (categorie.value === "mp") {
    blocMP.style.display = "block";
  }

  if (categorie.value === "ms") {
    blocMS.style.display = "block";
  }
});



 const fournisseurMP = document.getElementById("fournisseurMP");
const champsMP = document.getElementById("champs-mp");

const blocsProduitsMP = {
  Montaigu: document.getElementById("produits-Montaigu"),
  Socovo: document.getElementById("produits-Socovo"),
  Giraudon: document.getElementById("produits-Giraudon"),
  Caragum: document.getElementById("produits-Caragum"),
  Aigremont: document.getElementById("produits-Aigremont"),
  Rogelfruits: document.getElementById("produits-Rogelfruits")
};
// üîÑ Appliquer automatiquement le seuil quand on choisit un produit MP
Object.values(blocsProduitsMP).forEach(bloc => {
  const select = bloc.querySelector("select");
  if (!select) return;

  select.addEventListener("change", () => {
    appliquerSeuil(select.value);
  });
});


fournisseurMP.addEventListener("change", () => {

  // cacher tous les produits
  Object.values(blocsProduitsMP).forEach(b => b.style.display = "none");
  champsMP.style.display = "none";

  // afficher produits + champs
  if (blocsProduitsMP[fournisseurMP.value]) {
    blocsProduitsMP[fournisseurMP.value].style.display = "block";
    champsMP.style.display = "block";
  }
});

const fournisseurMS = document.getElementById("fournisseurMS");

const blocsProduitsMS = {
  transgourmet: document.getElementById("produits-transgourmet"),
  metro: document.getElementById("produits-metro"),
  promocash: document.getElementById("produits-promocash")
};

const champsMS = document.getElementById("champs-ms");

fournisseurMS.addEventListener("change", () => {

  // cacher tous les blocs produits
  Object.values(blocsProduitsMS).forEach(b => b.style.display = "none");

  // cacher les champs communs
  champsMS.style.display = "none";

  // afficher produit + champs si fournisseur valide
  if (blocsProduitsMS[fournisseurMS.value]) {
    blocsProduitsMS[fournisseurMS.value].style.display = "block";
    champsMS.style.display = "block";
  }
});
 
function resetAjoutStock() {
  // reset cat√©gorie
  const categorie = document.getElementById("categorie");
  categorie.value = "";

  // reset MP
  document.getElementById("fournisseurMP").value = "";
  document.getElementById("lot").value = "";
  document.getElementById("dlc").value = "";
  document.getElementById("quantite").value = "";
  document.getElementById("seuil").value = "";

  // reset MS
  document.getElementById("fournisseurMS").value = "";
  document.getElementById("quantiteMS").value = "";
  document.getElementById("seuilMS").value = "";

  // cacher uniquement les sous-blocs
  document.getElementById("bloc-mp").style.display = "none";
  document.getElementById("bloc-ms").style.display = "none";

  document.getElementById("champs-mp").style.display = "none";
  document.getElementById("champs-ms").style.display = "none";
}

 function afficherHistorique() {
  const tbody = document.getElementById("tableHistorique");
  if (!tbody) return;

  tbody.innerHTML = "";

  historiqueMois.forEach(h => {
    tbody.innerHTML += `
      <tr>
        <td>${h.date}</td>
        <td>${h.matiere}</td>
        <td>${h.lot}</td>
        <td>${h.quantite}</td>
      </tr>
    `;
  });
}
 
function editerSortie(id) {
  const sortie = sortiesMois.find(s => s.id === id);
  if (!sortie) return;

  const li = document.getElementById("sortie-" + id);
  if (!li) return;

  li.innerHTML = `
    <input type="number" id="edit-qte-${id}" value="${sortie.quantite}" style="width:70px">
    <button onclick="validerEditSortie(${id})">üíæ</button>
    <button onclick="afficherSortiesMois()">‚ùå</button>
  `;
}


window.editerSortie = editerSortie;


 
async function validerEditSortie(id) {
  const sortie = sortiesMois.find(s => s.id === id);
  if (!sortie) return;

  const nouvelleQte = Number(document.getElementById("edit-qte-" + id).value);
  if (!nouvelleQte || nouvelleQte <= 0) return;

  const delta = sortie.quantite - nouvelleQte;

  const lotStock = stock.find(l =>
    l.matiere === sortie.matiere &&
    l.lot === sortie.lot
  );

  if (!lotStock) {
    alert("Lot d'origine introuvable");
    return;
  }

  // remise ou retrait stock
  lotStock.sacs += delta;
  if (lotStock.sacs < 0) {
    alert("Stock insuffisant");
    return;
  }

  sortie.quantite = nouvelleQte;

  await save();
  afficher();
  afficherSortiesMois();
}


window.validerEditSortie = validerEditSortie;



function formatDateISO(dateFR) {
  const [d, m, y] = dateFR.split("/");
  return `${y}-${m.padStart(2,"0")}-${d.padStart(2,"0")}`;
}

window.openSection = openSection;
window.retourAccueil = retourAccueil;
window.ajouterLot = ajouterLot;
window.validerSortie = validerSortie;
window.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".home-card").forEach(card => {
    card.addEventListener("click", () => {
      const section = card.dataset.section;
      console.log("CLICK:", section); // debug
      window.openSection(section);
    });
  });
});

async function supprimerSortie(id) {
  const sortie = sortiesMois.find(s => s.id === id);
  if (!sortie) return;

  if (!confirm("Supprimer cette sortie et r√©attribuer le stock ?")) return;

  // üîÅ R√©attribuer le stock
  const lotStock = stock.find(l =>
    l.matiere === sortie.matiere &&
    l.lot === sortie.lot
  );

  if (lotStock) {
    lotStock.sacs += sortie.quantite;
  }

  // ‚ùå Supprimer sortie
  sortiesMois = sortiesMois.filter(s => s.id !== id);

  // ‚ùå Supprimer historique correspondant
  historiqueMois = historiqueMois.filter(h => h.id !== id);

  await save();
  afficher();
  afficherSortiesMois();
}

window.supprimerSortie = supprimerSortie;


 function editerStock(index) {
  const l = stock[index];
  if (!l) return;

  const qte = prompt("Quantit√© en stock (sacs) :", l.sacs);
  if (qte === null) return;

  const seuil = prompt("Seuil d‚Äôalerte :", l.seuil || 0);
  if (seuil === null) return;

  l.sacs = Number(qte);
  l.seuil = Number(seuil);

  save();
  afficher();
}

 function supprimerStock(index) {
  const lot = stock[index];
  if (!lot) return;

  const message = `
Supprimer le lot :
${lot.matiere}
Lot : ${lot.lot || "SANS LOT"}

‚ö†Ô∏è Toutes les sorties associ√©es seront aussi supprim√©es.
  `;

  if (!confirm(message)) return;

  // üî• SUPPRESSION DES SORTIES DU MOIS
  sortiesMois = sortiesMois.filter(s =>
    !(s.matiere === lot.matiere && s.lot === lot.lot)
  );

  // üî• SUPPRESSION DE L‚ÄôHISTORIQUE
  historiqueMois = historiqueMois.filter(h =>
    !(h.matiere === lot.matiere && h.lot === lot.lot)
  );

  // üî• SUPPRESSION DU LOT DU STOCK
  stock.splice(index, 1);

  save();
  afficher();
  afficherSortiesMois();
  afficherHistorique();
}

window.editerStock = editerStock;
window.supprimerStock = supprimerStock;

function nettoyerHistoriqueOrphelin() {
  const idsValides = sortiesMois.map(s => s.id);

  historiqueMois = historiqueMois.filter(h =>
    h.id && idsValides.includes(h.id)
  );
}

function appliquerSeuil(matiere) {
  const inputSeuil = document.getElementById("seuil");
  if (!inputSeuil) return;

  inputSeuil.value = seuilsParMatiere[matiere] ?? "";
}


</script>

</div>

</body>
</html>

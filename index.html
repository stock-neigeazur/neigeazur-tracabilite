<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Traçabilité matières – Neige Azur</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family: Arial, sans-serif; padding: 15px; }
h1 { color: #003366; }

input, select, button {
  width: 100%;
  padding: 8px;
  margin: 6px 0;
}

button { cursor: pointer; }

.tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
}

.tabs button {
  flex: 1;
  background: #e0e0e0;
  border: none;
  padding: 10px;
  font-weight: bold;
}

.tabs button.active {
  background: #003366;
  color: white;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}

th, td {
  border: 1px solid #ccc;
  padding: 6px;
  text-align: center;
}

.ok { background: #d4edda; }
.soon { background: #fff3cd; }
.expired { background: #f8d7da; }
</style>
</head>

<body>

<h1>Traçabilité matières – Neige Azur</h1>

<div class="tabs">
  <button id="btn-mp" class="active" onclick="showTab('mp')">Matières premières</button>
  <button id="btn-ms" onclick="showTab('ms')">Matières secondaires</button>
  <button id="btn-hist" onclick="showTab('hist')">Historique</button>
</div>

<div id="tab-mp">

<h3>Ajouter un lot</h3>

<select id="matiere">
  <option value="Sucre">Sucre</option>
  <option value="Sucre inverti">Sucre inverti</option>
  <option value="Dextrose">Dextrose</option>
  <option value="Glucose">Glucose</option>
  <option value="Lait entier">Lait entier</option>
  <option value="Lait 0%">Lait 0%</option>
  <option value="Crème 35%">Crème 35%</option>
  <option value="Jaune d'œuf">Jaune d'œuf</option>
  <option value="Huile de coco">Huile de coco</option>
  <option value="Stabilisateur glace">Stabilisateur glace</option>
  <option value="Stabilisateur sorbet">Stabilisateur sorbet</option>
  <option value="Purée de fruits">Purée de fruits</option>
  <option value="Autre">Autre (à préciser)</option>
</select>

<input id="matiereAutre" placeholder="Préciser la matière" style="display:none">

<select id="fournisseur">
  <option value="">— Choisir un fournisseur —</option>
  <option value="Montaigu">Montaigu</option>
  <option value="Giraudon">Giraudon</option>
  <option value="Fedpa">Fedpa</option>
  <option value="Socovo">Socovo</option>
  <option value="Rogelfruits">Rogelfruits</option>
  <option value="Autre">Autre (à préciser)</option>
</select>

<input id="fournisseurAutre" placeholder="Préciser le fournisseur" style="display:none">
<input id="lot" placeholder="Numéro de lot">

<select id="type">
  <option value="DLUO">DLUO</option>
  <option value="DLC">DLC</option>
</select>

<input id="dlc" type="date">
<input id="quantite" type="number" placeholder="Quantité (sacs)">

<button onclick="ajouterLot()">Ajouter</button>

<h3>Stock actuel</h3>

<table>
<thead>
<tr>
<th>Matière</th>
<th>Fournisseur</th>
<th>Lot</th>
<th>DLC / DLUO</th>
<th>Quantité</th>
<th>Sortie</th>
</tr>
</thead>
<tbody id="tableStock"></tbody>
</table>

<h3>Sorties du mois en cours</h3>
<ul id="sortiesMoisListe"></ul>

</div>

<div id="tab-hist" style="display:none;">

<h3>Historique des sorties</h3>

<select id="moisSelect">
  <option value="">— Choisir un mois —</option>
</select>

<table>
<thead>
<tr>
<th>Date</th>
<th>Matière</th>
<th>Lot</th>
<th>Quantité</th>
</tr>
</thead>
<tbody id="tableHistorique"></tbody>
</table>

</div>

<div id="tab-ms" style="display:none;">
  <h3>Matières secondaires</h3>
  <p>Module à venir.</p>
</div>

<script>
let stock = JSON.parse(localStorage.getItem("stock")) || [];
let sortiesMois = JSON.parse(localStorage.getItem("sortiesMois")) || [];
let historiqueMois = JSON.parse(localStorage.getItem("historiqueMois")) || [];
let moisActuel = Number(localStorage.getItem("moisActuel")) || new Date().getMonth();

function save(){
  localStorage.setItem("stock", JSON.stringify(stock));
  localStorage.setItem("sortiesMois", JSON.stringify(sortiesMois));
}

function showTab(tab){
  document.getElementById("tab-mp").style.display   = tab === "mp"   ? "block" : "none";
  document.getElementById("tab-hist").style.display = tab === "hist" ? "block" : "none";
  document.getElementById("tab-ms").style.display   = tab === "ms"   ? "block" : "none";

  document.getElementById("btn-mp").classList.toggle("active", tab === "mp");
  document.getElementById("btn-hist").classList.toggle("active", tab === "hist");
  document.getElementById("btn-ms").classList.toggle("active", tab === "ms");
}

function ajouterLot(){
  if(!lot.value || !quantite.value) return;

  stock.unshift({
  matiere: matiere.value === "Autre"
    ? matiereAutre.value
    : matiere.value,
  fournisseur: fournisseur.value === "Autre"
    ? fournisseurAutre.value
    : fournisseur.value,
  lot: lot.value,
  type: type.value,
  date: dlc.value || "",
  sacs: Number(quantite.value)
});

  save();
  afficher();

  lot.value = "";
  quantite.value = "";
}

function afficher(){
  tableStock.innerHTML = "";

  stock.forEach((x,i)=>{
    tableStock.innerHTML += `
      <tr>
        <td>${x.matiere}</td>
        <td>${x.fournisseur}</td>
        <td>${x.lot}</td>
        <td>${x.date}</td>
        <td>${x.sacs}</td>
        <td>
          <input type="number" id="sortie-${i}" style="width:60px">
          <button onclick="validerSortie(${i})">Valider</button>
        </td>
      </tr>
    `;
  });

  afficherSortiesMois();
}

function validerSortie(i){
  const q = Number(document.getElementById("sortie-"+i).value);
  if(!q || q > stock[i].sacs) return;

  stock[i].sacs -= q;
  sortiesMois.push({
    date: new Date().toLocaleDateString(),
    matiere: stock[i].matiere,
    lot: stock[i].lot,
    quantite: q
  });

  save();
  afficher();
}

function afficherSortiesMois(){
  sortiesMoisListe.innerHTML = "";
  sortiesMois.forEach(s=>{
    sortiesMoisListe.innerHTML += `<li>${s.date} – ${s.quantite} sacs ${s.matiere}</li>`;
  });
}

function verifierChangementMois(){
  const m = new Date().getMonth();
  if(m !== moisActuel && sortiesMois.length){
    historiqueMois.push({ mois: moisActuel, sorties: sortiesMois });
    sortiesMois = [];
    moisActuel = m;
    localStorage.setItem("historiqueMois", JSON.stringify(historiqueMois));
    localStorage.setItem("sortiesMois", JSON.stringify(sortiesMois));
    localStorage.setItem("moisActuel", moisActuel);
  }
}

fournisseur.addEventListener("change", () => {
  fournisseurAutre.style.display =
    fournisseur.value === "Autre" ? "block" : "none";
});

matiere.addEventListener("change", () => {
  matiereAutre.style.display =
    matiere.value === "Autre" ? "block" : "none";
});

verifierChangementMois();
afficher();
</script>

</body>
</html>

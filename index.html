<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Traçabilité matières – Neige Azur</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family: Arial, sans-serif; padding: 15px; }
h1 { color: #003366; }

input, select, button {
  width: 100%;
  padding: 8px;
  margin: 6px 0;
}

button { cursor: pointer; }

.tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
}

.tabs button {
  flex: 1;
  background: #e0e0e0;
  border: none;
  padding: 10px;
  font-weight: bold;
}

.tabs button.active {
  background: #003366;
  color: white;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}

th, td {
  border: 1px solid #ccc;
  padding: 6px;
  text-align: center;
}

.ok { background: #d4edda; }
.soon { background: #fff3cd; }
.expired { background: #f8d7da; }
</style>
</head>

<body>

<h1>Traçabilité matières – Neige Azur</h1>

<!-- ONGLET -->
<div class="tabs">
  <button id="btn-mp" class="active" onclick="showTab('mp')">Matières premières</button>
  <button id="btn-ms" onclick="showTab('ms')">Matières secondaires</button>
</div>

<!-- ================= MATIÈRES PREMIÈRES ================= -->
<div id="tab-mp">

<h3>Ajouter un lot</h3>

<select id="matiere">
  <optgroup label="Glaces et Sorbets">
    <option value="Sucre">Sucre</option>
    <option value="Sucre inverti">Sucre inverti</option>
    <option value="Dextrose">Dextrose</option>
    <option value="Glucose">Glucose</option>
    <option value="Huile de coco">Huile de coco</option>
    <option value="Lait entier">Lait entier</option>
    <option value="Crème">Crème</option>
    <option value="Lait en poudre">Lait en poudre</option>
    <option value="Stabilisateur glace">Stabilisateur glace</option>
    <option value="Stabilisateur sorbet">Stabilisateur sorbet</option>
    <option value="Purée de fruits">Purée de fruits</option>
  </optgroup>
  <option value="Autre">Autre (à préciser)</option>
</select>

<input id="matiereAutre" placeholder="Préciser la matière (si autre)" style="display:none">
<input id="fournisseur" placeholder="Fournisseur">
<input id="lot" placeholder="Numéro de lot">

<select id="type">
  <option value="DLUO">DLUO</option>
  <option value="DLC">DLC</option>
</select>

<input id="dlc" type="date">
<input id="quantite" type="number" placeholder="Quantité (sacs)">

<button onclick="ajouterLot()">Ajouter</button>

<h3>Stock actuel</h3>

<button onclick="exportStock()">Exporter le stock (CSV)</button>
<button onclick="exportHistorique()">Exporter l’historique (CSV)</button>

<table>
<thead>
<tr>
<th>Matière</th>
<th>Fournisseur</th>
<th>Lot</th>
<th>DLC / DLUO</th>
<th>Quantité</th>
<th>Sortie</th>
</tr>
</thead>
<tbody id="tableStock"></tbody>
</table>

<h3>Historique des sorties</h3>
<ul id="historique"></ul>

</div>

<!-- ================= MATIÈRES SECONDAIRES ================= -->
<div id="tab-ms" style="display:none;">
  <h3>Matières secondaires</h3>
  <p>Module à venir.</p>
</div>

<script>
let stock = JSON.parse(localStorage.getItem("stock")) || [];
let hist = JSON.parse(localStorage.getItem("hist")) || [];

/* ONGLET */
function showTab(tab){
  document.getElementById("tab-mp").style.display = tab === "mp" ? "block" : "none";
  document.getElementById("tab-ms").style.display = tab === "ms" ? "block" : "none";
  document.getElementById("btn-mp").classList.toggle("active", tab === "mp");
  document.getElementById("btn-ms").classList.toggle("active", tab === "ms");
}

/* STOCK */
function save(){
  localStorage.setItem("stock", JSON.stringify(stock));
  localStorage.setItem("hist", JSON.stringify(hist));
}

function ajouterLot(){
  if(!lot.value || !quantite.value){
    alert("Lot et quantité obligatoires.");
    return;
  }

  stock.push({
    matiere: matiere.value === "Autre" ? matiereAutre.value : matiere.value,
    fournisseur: fournisseur.value || "—",
    lot: lot.value,
    type: type.value,
    date: dlc.value || "",
    sacs: Number(quantite.value)
  });

  save();
  afficher();

  matiereAutre.value = "";
  fournisseur.value = "";
  lot.value = "";
  dlc.value = "";
  quantite.value = "";
}

function afficher(){
  tableStock.innerHTML = "";
  historique.innerHTML = "";
  const now = new Date();

  stock.sort((a,b)=>{
    if(!a.date) return 1;
    if(!b.date) return -1;
    return new Date(a.date) - new Date(b.date);
  });

  stock.forEach((x,i)=>{
    let classe = "ok";
    let dateAff = "—";

    if(x.date){
      const d = new Date(x.date);
      const diff = (d - now) / 86400000;
      dateAff = x.date.split("-").reverse().join("/");
      if(diff < 0) classe = "expired";
      else if(diff < (x.type === "DLC" ? 15 : 30)) classe = "soon";
    }

    tableStock.innerHTML += `
      <tr class="${classe}">
        <td>${x.matiere}</td>
        <td>${x.fournisseur}</td>
        <td>${x.lot}</td>
        <td>${dateAff}</td>
        <td>${x.sacs}</td>
        <td>
          <input type="number" min="0" style="width:60px" id="sortie-${i}" placeholder="0">
          <button onclick="validerSortie(${i})">Valider</button>
        </td>
      </tr>
    `;
  });

  hist.forEach(h => historique.innerHTML += `<li>${h}</li>`);
}

function validerSortie(index){
  const champ = document.getElementById("sortie-" + index);
  const sortie = Number(champ.value);

  if(!sortie || sortie <= 0){
    alert("Indique un nombre de sacs à sortir.");
    return;
  }

  if(sortie > stock[index].sacs){
    alert("Sortie supérieure au stock disponible.");
    return;
  }

  stock[index].sacs -= sortie;

  hist.unshift(
    new Date().toLocaleDateString() +
    " : " +
    sortie +
    " sac(s) SORTI(S) " +
    stock[index].matiere +
    " (lot " + stock[index].lot + ")"
  );

  champ.value = "";
  save();
  afficher();
}

/* EXPORT */
function exportStock(){
  let csv = "Matière;Fournisseur;Lot;Type;Date;Quantité\n";
  stock.forEach(x=>{
    csv += `${x.matiere};${x.fournisseur};${x.lot};${x.type};${x.date};${x.sacs}\n`;
  });
  telechargerCSV(csv,"stock_neige_azur.csv");
}

function exportHistorique(){
  let csv = "Historique\n";
  hist.forEach(h=>csv+=h+"\n");
  telechargerCSV(csv,"historique_neige_azur.csv");
}

function telechargerCSV(contenu, nom){
  const blob = new Blob([contenu], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = nom;
  a.click();
}

matiere.addEventListener("change",()=>{
  matiereAutre.style.display = matiere.value === "Autre" ? "block" : "none";
});

afficher();
</script>

</body>
</html>

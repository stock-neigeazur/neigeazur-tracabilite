 <!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Tra√ßabilit√© mati√®res ‚Äì Neige Azur</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
<link rel="manifest" href="manifest.json">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Neige Azur">

<style>
body { font-family: Arial, sans-serif; padding: 15px; }
h1 { color: #003366; }

input, select, button {
  width: 100%;
  padding: 8px;
  margin: 6px 0;
}

button { cursor: pointer; }

.tabs {
  display: flex;
  gap: 8px;
  margin: 15px 0 20px;
}

.tabs button {
  flex: 1;
  border: none;
  padding: 12px 8px;
  font-weight: 600;
  font-size: 14px;
  border-radius: 12px;
  background: #e5e7eb;        /* gris clair neutre */
  color: #374151;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  transition: all 0.2s ease;
}

/* Mati√®res premi√®res */
#btn-mp.active {
  background: #2563eb;        /* bleu */
  color: #fff;
}

/* Mati√®res secondaires */
#btn-ms.active {
  background: #16a34a;        /* vert */
  color: #fff;
}

/* Historique */
#btn-hist.active {
  background: #f59e0b;        /* orange */
  color: #fff;
}

/* petit effet au toucher */
.tabs button:active {
  transform: scale(0.97);
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}

th, td {
  border: 1px solid #ccc;
  padding: 6px;
  text-align: center;
}

.ok { background: #d4edda; }
.soon { background: #fff3cd; }
.expired { background: #f8d7da; }
.logo {
  display: block;
  margin: 20px auto 10px;
  max-width: 100px;
  height: auto;
}
 .home-title {
  text-align: center;
  margin: 20px 0 30px;
}

.home-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
  padding: 10px;
}

.home-card {
  background: #ffffff;
  border-radius: 18px;
  padding: 25px 10px;
  text-align: center;
  box-shadow: 0 6px 14px rgba(0,0,0,0.08);
  cursor: pointer;
  transition: transform 0.1s ease, box-shadow 0.1s ease;
}

.home-card:active {
  transform: scale(0.97);
  box-shadow: 0 4px 10px rgba(0,0,0,0.12);
}

.home-card .icon {
  font-size: 36px;
  margin-bottom: 10px;
}

.home-card .label {
  font-weight: bold;
  font-size: 15px;
}
</style>
</head>

<body>

<img src="logo-neige-azur.png" alt="Neige Azur" class="logo">

 <div id="home">

  <h1 class="home-title">Gestion des stocks</h1>

  <div class="home-grid">

    <div class="home-card" onclick="openSection('ajout')">
      <div class="icon">‚ûï</div>
      <div class="label">Ajout stock</div>
    </div>

    <div class="home-card" onclick="openSection('stock')">
      <div class="icon">üì¶</div>
      <div class="label">Stock</div>
    </div>

    <div class="home-card" onclick="openSection('historique')">
      <div class="icon">üßæ</div>
      <div class="label">Historique sorties</div>
    </div>

    <div class="home-card" onclick="openSection('stats')">
      <div class="icon">üìä</div>
      <div class="label">Stats</div>
    </div>

  </div>

</div>

<div id="app" style="display:none;">

<button onclick="retourAccueil()">üè† Accueil</button>

<h1>Tra√ßabilit√© mati√®res ‚Äì Neige Azur</h1>

<div class="tabs">
  <button id="btn-mp" class="active" onclick="showTab('mp')">Mati√®res premi√®res</button>
  <button id="btn-ms" onclick="showTab('ms')">Mati√®res secondaires</button>
  <button id="btn-hist" onclick="showTab('hist')">Historique</button>
</div>

<div id="tab-mp">

<h3>Ajouter un lot</h3>

<select id="matiere">
  <option value="Sucre">Sucre</option>
  <option value="Sucre inverti">Sucre inverti</option>
  <option value="Dextrose">Dextrose</option>
  <option value="Glucose">Glucose</option>
  <option value="Lait entier">Lait entier</option>
  <option value="Lait 0%">Lait 0%</option>
  <option value="Cr√®me 35%">Cr√®me 35%</option>
  <option value="Jaune d'≈ìuf">Jaune d'≈ìuf</option>
  <option value="Huile de coco">Huile de coco</option>
  <option value="Stabilisateur glace">Stabilisateur glace</option>
  <option value="Stabilisateur sorbet">Stabilisateur sorbet</option>
  <option value="Pur√©e de fruits">Pur√©e de fruits</option>
  <option value="Autre">Autre (√† pr√©ciser)</option>
</select>

<input id="matiereAutre" placeholder="Pr√©ciser la mati√®re" style="display:none">

<select id="fournisseur">
  <option value="">‚Äî Choisir un fournisseur ‚Äî</option>
  <option value="Montaigu">Montaigu</option>
  <option value="Giraudon">Giraudon</option>
  <option value="Fedpa">Fedpa</option>
  <option value="Socovo">Socovo</option>
  <option value="Rogelfruits">Rogelfruits</option>
  <option value="Autre">Autre (√† pr√©ciser)</option>
</select>

<input id="fournisseurAutre" placeholder="Pr√©ciser le fournisseur" style="display:none">
<input id="lot" placeholder="Num√©ro de lot">

<select id="type">
  <option value="DLUO">DLUO</option>
  <option value="DLC">DLC</option>
</select>

<input id="dlc" type="date">
<input id="quantite" type="number" placeholder="Quantit√© (sacs)">

<button onclick="ajouterLot().catch(console.error)">Ajouter</button>

<h3>Stock actuel</h3>

<table>
<thead>
<tr>
<th>Mati√®re</th>
<th>Fournisseur</th>
<th>Lot</th>
<th>DLC / DLUO</th>
<th>Quantit√©</th>
<th>Sortie</th>
</tr>
</thead>
<tbody id="tableStock"></tbody>
</table>

<h3>Sorties du mois en cours</h3>
<ul id="sortiesMoisListe"></ul>

</div>

<div id="tab-hist" style="display:none;">

<h3>Historique des sorties</h3>

<select id="moisSelect">
  <option value="">‚Äî Choisir un mois ‚Äî</option>
</select>

<table>
<thead>
<tr>
<th>Date</th>
<th>Mati√®re</th>
<th>Lot</th>
<th>Quantit√©</th>
</tr>
</thead>
<tbody id="tableHistorique"></tbody>
</table>

</div>

<div id="tab-ms" style="display:none;">
  <h3>Mati√®res secondaires</h3>
  <p>Module √† venir.</p>
</div>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import {
    getFirestore,
    doc,
    getDoc,
    setDoc,
    onSnapshot
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "TON_API_KEY",
    authDomain: "neigeazur-stock.firebaseapp.com",
    projectId: "neigeazur-stock",
    storageBucket: "neigeazur-stock.appspot.com",
    messagingSenderId: "XXXXXXXX",
    appId: "XXXXXXXX"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.db = db;
  window.doc = doc;
  window.getDoc = getDoc;
  window.setDoc = setDoc;
  window.onSnapshot = onSnapshot;
</script>

<script>

let stock = [];
let sortiesMois = [];
let historiqueMois = [];
let moisActuel = new Date().getMonth();

// üîß R√©f√©rences DOM (OBLIGATOIRE avec type="module")
const matiere = document.getElementById("matiere");
const matiereAutre = document.getElementById("matiereAutre");
const fournisseur = document.getElementById("fournisseur");
const fournisseurAutre = document.getElementById("fournisseurAutre");
const lot = document.getElementById("lot");
const type = document.getElementById("type");
const dlc = document.getElementById("dlc");
const quantite = document.getElementById("quantite");

const tableStock = document.getElementById("tableStock");
const sortiesMoisListe = document.getElementById("sortiesMoisListe");

async function save() {
  const ref = doc(window.db, "neigeazur", "data");

  await setDoc(
    ref,
    {
      stock: stock,
      sortiesMois: sortiesMois,
      historiqueMois: historiqueMois,
      moisActuel: moisActuel,
      updatedAt: new Date()
    },
    { merge: true }
  );
}

function showTab(tab){
  document.getElementById("tab-mp").style.display   = tab === "mp"   ? "block" : "none";
  document.getElementById("tab-hist").style.display = tab === "hist" ? "block" : "none";
  document.getElementById("tab-ms").style.display   = tab === "ms"   ? "block" : "none";

  document.getElementById("btn-mp").classList.toggle("active", tab === "mp");
  document.getElementById("btn-hist").classList.toggle("active", tab === "hist");
  document.getElementById("btn-ms").classList.toggle("active", tab === "ms");
}

async function ajouterLot(){
  if(!lot.value || !quantite.value) return;

  stock.unshift({
    matiere: matiere.value === "Autre" ? matiereAutre.value : matiere.value,
    fournisseur: fournisseur.value === "Autre" ? fournisseurAutre.value : fournisseur.value,
    lot: lot.value,
    type: type.value,
    date: dlc.value || "",
    sacs: Number(quantite.value)
  });

  save().catch(console.error);
  afficher();

  lot.value = "";
  quantite.value = "";
}

// üîß Exposition des fonctions pour les onclick HTML
window.ajouterLot = ajouterLot;
window.validerSortie = validerSortie;
window.showTab = showTab;
 
function afficher(){
  tableStock.innerHTML = "";

  stock.forEach((x,i)=>{
    tableStock.innerHTML += `
      <tr>
        <td>${x.matiere}</td>
        <td>${x.fournisseur}</td>
        <td>${x.lot}</td>
        <td>${x.date}</td>
        <td>${x.sacs}</td>
        <td>
          <input type="number" id="sortie-${i}" style="width:60px">
          <button onclick="validerSortie(${i})">Valider</button>
        </td>
      </tr>
    `;
  });

  afficherSortiesMois();
}

async function validerSortie(i){
  const q = Number(document.getElementById("sortie-"+i).value);
  if(!q || q > stock[i].sacs) return;

  stock[i].sacs -= q;
  sortiesMois.push({
    date: new Date().toLocaleDateString(),
    matiere: stock[i].matiere,
    lot: stock[i].lot,
    quantite: q
  });

  await save();   // ‚¨ÖÔ∏è POINT CL√â
  afficher();
}
function afficherSortiesMois(){
  sortiesMoisListe.innerHTML = "";
  sortiesMois.forEach(s=>{
    sortiesMoisListe.innerHTML += `<li>${s.date} ‚Äì ${s.quantite} sacs ${s.matiere}</li>`;
  });
}

async function chargerDonneesFirebase() {
  const ref = doc(window.db, "neigeazur", "data");
  const snap = await getDoc(ref);

  if (snap.exists()) {
    const data = snap.data();
    stock = data.stock || [];
    sortiesMois = data.sortiesMois || [];
    historiqueMois = data.historiqueMois || [];
    moisActuel = data.moisActuel ?? new Date().getMonth();
  } else {
    await setDoc(ref, {
      stock: [],
      sortiesMois: [],
      historiqueMois: [],
      moisActuel: new Date().getMonth(),
      updatedAt: new Date()
    });
  }

  afficher();
  afficherSortiesMois();
}

function ecouterFirebase() {
  const ref = doc(window.db, "neigeazur", "data");

  onSnapshot(ref, (snap) => {
    if (snap.exists()) {
      const data = snap.data();
      stock = data.stock || [];
      sortiesMois = data.sortiesMois || [];
      historiqueMois = data.historiqueMois || [];
      moisActuel = data.moisActuel ?? new Date().getMonth();

      afficher();
      afficherSortiesMois();
    }
  });
}

fournisseur.addEventListener("change", () => {
  fournisseurAutre.style.display = fournisseur.value === "Autre" ? "block" : "none";
});

matiere.addEventListener("change", () => {
  matiereAutre.style.display = matiere.value === "Autre" ? "block" : "none";
});

function openSection(section) {
  document.getElementById("home").style.display = "none";
  document.getElementById("app").style.display = "block";

  if (section === "ajout") showTab("mp");
  if (section === "stock") showTab("mp");
  if (section === "historique") showTab("hist");
  if (section === "stats") alert("Stats √† venir");
}

function retourAccueil() {
  document.getElementById("app").style.display = "none";
  document.getElementById("home").style.display = "block";
}

window.addEventListener("load", () => {
  chargerDonneesFirebase();
  ecouterFirebase();
});
</script>

</div>

</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Neige Azur – Traçabilité MP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; padding: 15px; }
    h1 { color: #003366; }
    input, button { width: 100%; padding: 8px; margin: 5px 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    .ok { background: #c8f7c5; }
    .soon { background: #fff3cd; }
    .expired { background: #f8d7da; }
  </style>
</head>
<body>

<h1>Traçabilité matières premières – Neige Azur</h1>

<h3>Ajouter un lot</h3>
<input id="matiere" placeholder="Matière première">
<input id="fournisseur" placeholder="Fournisseur">
<input id="lot" placeholder="Numéro de lot">
<input id="dlc" type="date">
<input id="quantite" type="number" placeholder="Nombre de sacs">

<button onclick="ajouterLot()">Ajouter</button>

<h3>Stock actuel</h3>
<table>
<thead>
<tr>
<th>Matière</th>
<th>Fournisseur</th>
<th>Lot</th>
<th>DLC / DLUO</th>
<th>Sacs restants</th>
<th>Action</th>
</tr>
</thead>
<tbody id="tableStock"></tbody>
</table>

<script>
let stock = JSON.parse(localStorage.getItem("stock")) || [];

function sauver() {
  localStorage.setItem("stock", JSON.stringify(stock));
}

function ajouterLot() {
  stock.push({
    matiere: matiere.value,
    fournisseur: fournisseur.value,
    lot: lot.value,
    dlc: dlc.value,
    sacs: Number(quantite.value)
  });
  sauver();
  afficher();
}

function sortirSac(index) {
  if (stock[index].sacs > 0) {
    stock[index].sacs--;
    sauver();
    afficher();
  }
}

<script>
function afficher(){
  tableStock.innerHTML="";
  historique.innerHTML="";
  const now=new Date();

  // TRI FIFO (date la plus ancienne d'abord, les sans date à la fin)
  stock.sort((a,b)=>{
    if(!a.date) return 1;
    if(!b.date) return -1;
    return new Date(a.date)-new Date(b.date);
  });

  stock.forEach((x,i)=>{
    let classe="ok";
    let dateAff="—";

    if(x.date){
      const d=new Date(x.date);
      const diff=(d-now)/86400000;
      dateAff=x.date.split("-").reverse().join("/");

      if(diff<0) classe="expired";
      else if(diff<(x.type==="DLC"?15:30)) classe="soon";
    }

    tableStock.innerHTML+=`
    <tr class="${classe}">
      <td>${x.matiere}</td>
      <td>${x.fournisseur}</td>
      <td>${x.lot}</td>
      <td>${dateAff}</td>
      <td>${x.sacs}</td>
      <td>
        <button onclick="confirmerSortie(${i})" ${x.sacs===0?"disabled":""}>
          -1 sac
        </button>
      </td>
    </tr>`;
  });

  hist.forEach(h=>historique.innerHTML+=`<li>${h}</li>`);
}

function confirmerSortie(i){
  if(confirm("Confirmer la sortie d’un sac ?")){
    sortirSac(i);
  }
}
</script>

</body>
</html>
